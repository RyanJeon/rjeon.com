<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>(SideTrack 1) File Polyglot</title>
	
	<meta name="author" content="Ryan Jeon">

	<!-- Enable responsive viewport -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
	<!--[if lt IE 9]>
	<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->

	<!-- Le styles -->
	<link href="/assets/resources/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	<link href="/assets/resources/font-awesome/css/font-awesome.min.css" rel="stylesheet">
	<link href="/assets/resources/syntax/syntax.css" rel="stylesheet">
	<link href="/assets/css/style.css" rel="stylesheet">

	<!-- Le fav and touch icons -->
	<link rel="shortcut icon" href="/pingu.png">
	<!--	
	<link rel="apple-touch-icon" href="images/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
	-->


	<link rel="alternate" type="application/rss+xml" title="" href="/feed.xml">
</head>

<body>
	<nav class="navbar navbar-default visible-xs" role="navigation">
		<!-- Brand and toggle get grouped for better mobile display -->
		<div class="navbar-header">
			<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			
			<a type="button" class="navbar-toggle nav-link" href="http://github.com/ryanjeon">
				<i class="fa fa-github"></i>
			</a>
			
			
			
			<a type="button" class="navbar-toggle nav-link" href="mailto:ryanjeon98@gmail.com">
				<i class="fa fa-envelope"></i>
			</a>
			
			<a class="navbar-brand" href="/">
				<img src="https://s.gravatar.com/avatar/e687cb78cf4a1242610b00314122ce64?s=40" class="img-circle" />
				Ryan Jeon
			</a>
		</div>

		<!-- Collect the nav links, forms, and other content for toggling -->
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				<li class="active"><a href="/">Home</a></li>
				<li><a href="/categories.html">Categories</a></li>
				<li><a href="/tags.html">Tags</a></li>
			</ul>
		</div><!-- /.navbar-collapse -->
	</nav>

	<!-- nav-menu-dropdown -->
	<div class="btn-group hidden-xs" id="nav-menu">
		<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
			<i class="fa fa-bars"></i>
		</button>
		<ul class="dropdown-menu" role="menu">
			<li><a href="/"><i class="fa fa-home"></i>Home</a></li>
			<li class="divider"></li>
			<li><a href="#"><i class="fa fa-arrow-up"></i>Top of Page</a></li>
		</ul>
	</div>

	<div class="col-sm-3 sidebar hidden-xs" style="">
		<!-- sidebar.html -->
<header class="sidebar-header" role="banner">
	<a href="/">
		<img src="https://s.gravatar.com/avatar/e687cb78cf4a1242610b00314122ce64?s=200" class="img-circle" />
	</a>
	<h3 class="title">
        <a href="/">Ryan Jeon</a>
    </h3>
</header>


<div id="bio" class="text-center">
	I'm a software developer and a student. I am mainly interested in exploits and application development :)
</div>


<div id="contact-list" class="text-center">
	<div>
		<a class="btn btn-default btn-sm" style="margin:10px" href="/about.html">
			More About Me
		</a>
	</div>
	<ul class="list-unstyled list-inline">
		
		<li>
			<a class="btn btn-default btn-sm" href="https://github.com/ryanjeon">
				<i class="fa fa-github-alt fa-lg"></i>
			</a>
		</li>
		
		
		
		<li>
			<a class="btn btn-default btn-sm" href="mailto:ryanjeon98@gmail.com">
				<i class="fa fa-envelope fa-lg"></i>
			</a>
		</li>
		
	</ul>
	<ul id="contact-list-secondary" class="list-unstyled list-inline">
		
		
		<li>
			<a class="btn btn-default btn-sm" href="https://linkedin.com/in/ryan-yejun-jeon-70b4a7145">
				<i class="fa fa-linkedin fa-lg"></i>
			</a>
		</li>
		
		<li>
			<a class="btn btn-default btn-sm" href="/feed.xml">
				<i class="fa fa-rss fa-lg"></i>
			</a>
		</li>
	</ul>
</div>
<!-- sidebar.html end -->

	</div>

	<div class="col-sm-9 col-sm-offset-3">
		<div class="page-header">
  <h1>(SideTrack 1) File Polyglot </h1>
</div>


<article>

	<div class="col-sm-10">
	 <span class="post-date">
	   
	   June 
	   5th,
	   
	   2019
	 </span>
	  <div class="article_body" style="font-size: 20px">
	  <p><img src="https://illusion-investigation.weebly.com/uploads/2/4/2/2/24222135/6476083.jpg?306" alt="image" /></p>

<p>During my usual sidetrack, I stumbled upon a quite amusing video through my colleague. 
The video was covering a section of <a href="https://nostarch.com/gtfo">PoC || GTFO</a>, which 
was about a file polyglottery. Even though I was not able to find the original video I watched, <a href="https://www.youtube.com/watch?time_continue=1166&amp;v=fdKPnsWp9ho">here</a> is link to another video that covers the same topic. I encourage you to check it out. Just like what you might have guessed or already known, 
polyglot files can be interpreted as multiple different file types. Just think about how many nasty exploits you can do with these polyglot files. How exciting! I couldn’t 
help myself but to jump right into making one myself.</p>

<p>The first polyglot file that I attempted to make was a GIF + JS polyglot because it looked the most approachable and interesting. This <a href="https://stegosploit.info/">documentation</a> that I found had a very thorough explanation of an approach. Learning step by step, I began by analyzing the byte format of GIF files. Image files 
like PNG, JPEG, and GIF always begin with header bytes that contain meta data about 
the files such as size of the file, the width of the image, and the height of the image. If an image file does not have a valid header, it can’t be correctly decoded and you won’t be able to see the image. So we need to figure out how to embed our JavaScript into our GIF file without corrupting the header of the GIF file. This is 
the general format of GIF that I got from a <a href="https://www.fileformat.info/format/gif/egff.htm">source</a>:</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_GifHeader</span>
<span class="p">{</span>
  <span class="c1">// Header</span>
  <span class="n">BYTE</span> <span class="n">Signature</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>     <span class="cm">/* Header Signature (always "GIF") */</span>
  <span class="n">BYTE</span> <span class="n">Version</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>       <span class="cm">/* GIF format version("87a" or "89a") */</span>
  <span class="c1">// Logical Screen Descriptor</span>
  <span class="n">WORD</span> <span class="n">ScreenWidth</span><span class="p">;</span>      <span class="cm">/* Width of Display Screen in Pixels */</span>
  <span class="n">WORD</span> <span class="n">ScreenHeight</span><span class="p">;</span>     <span class="cm">/* Height of Display Screen in Pixels */</span>
  <span class="n">BYTE</span> <span class="n">Packed</span><span class="p">;</span>           <span class="cm">/* Screen and Color Map Information */</span>
  <span class="n">BYTE</span> <span class="n">BackgroundColor</span><span class="p">;</span>  <span class="cm">/* Background Color Index */</span>
  <span class="n">BYTE</span> <span class="n">AspectRatio</span><span class="p">;</span>      <span class="cm">/* Pixel Aspect Ratio */</span>
<span class="p">}</span> <span class="n">GIFHEAD</span><span class="p">;</span></code></pre></figure>

<p>As you can see, GIF file always start with a header signature “GIF” followed by 
the GIF format version. Notice that these 6 bytes can be used as a valid JavaScript 
variable? Even though we do not know if other succeeding bytes can be validly interpreted in common browsers like Chrome or Firefox, we are certain that the first 6 bytes 
will always be a valid JavaScript variable name. This means that we are good to go 
as long as we can bypass the other bytes. The fact that the screen width comes right 
after our golden 6 bytes is the key, because we can define the screen width with any 
2 bytes and still have a valid GIF header. So we can comment out the whole garbage 
bytes in the middle by setting our width to 0x2A2F (It will be a hell of a long GIF..) which translates to ‘/*’ and 
adding 0x2F2A ‘*/’,  at the end of the file to create a valid JavaScript comment.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript">    <span class="nx">GIF89a</span><span class="cm">/*...... (GIF image data) .....*/</span></code></pre></figure>

<p>Now to create a valid Javascript syntax, we can simply add ‘=SOME VALUE’ to 
define the variable at the top of our file.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript">    <span class="nx">GIF89a</span><span class="cm">/*...... (GIF image data) .....*/</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span></code></pre></figure>

<p>Then we can append any JavaScript we want.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript">    <span class="nx">GIF89a</span><span class="cm">/*...... (GIF image data) .....*/</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="nx">alert</span><span class="p">(</span><span class="s1">'This is cool!'</span><span class="p">);</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">':)'</span><span class="p">));</span></code></pre></figure>

<p>With such polyglot, we can do crazy things like using the same GIF file to render the GIF image and execute customized script as well in most browsers. Given our example above, the 
following HTML code will render our GIF, pop up an alert box, and log out ‘:)’.</p>

<figure class="highlight"><pre><code class="language-html" data-lang="html">    <span class="nt">&lt;html&gt;</span>
        <span class="nt">&lt;body&gt;</span>
            <span class="nt">&lt;img</span> <span class="na">src=</span><span class="s">"giphy.gif"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"giphy.gif"</span><span class="nt">&gt;&lt;/script&gt;</span>
        <span class="nt">&lt;/body&gt;</span>
    <span class="nt">&lt;/html&gt;</span></code></pre></figure>

<p>And we are done … But are we? What if there are bytes in the middle of the image that 
can translate into ‘*/’? This would surely break our method, because ‘/* */ */’ is not a valid JavaScript syntax and whatever that comes after the comment will not execute. Turns out, you will probably encounter bytes equivalent to ‘*/’ in the 
middle of the image in most GIFs, given how many bytes there are in a common GIF file. 
My attempt to bypass by removing and replacing the problematic bytes failed miserably, 
as it corrupted the file enough to make it look glitchy. Perhaps this doesn’t matter in most use cases of such polyglot, because it still will be intepreted as GIF with a valid header and successfully deliver desired scripts as long as there’s no <a href="https://en.wikipedia.org/wiki/Content_Disarm_%26_Reconstruction">CDR</a> present. Anyways, <a href="https://github.com/RyanJeon/Polyglot">here</a> is the code that I wrote to assist generating polyglot files. Hope you found 
this fun to explore as well.</p>

	  </div>

		
		<ul class="tag_box list-unstyled list-inline">
		  <li><i class="fa fa-folder-open"></i></li>
		  
		  
			 
				<li><a href="/categories.html#general-ref">
					general <span>(7)</span>
					,
				</a></li>
			 
				<li><a href="/categories.html#demo-ref">
					demo <span>(3)</span>
					
				</a></li>
			
		  
		</ul>
		  

		
		<ul class="list-inline">
		  <li><i class="fa fa-tags"></i></li>
		  
		  
			 
				<li>
					<a href="/tags.html#sidetrack-ref">
					sidetrack <span>(3)</span>
					
					</a>
				</li>
			
		  
		  
		</ul>
		  

		<hr>

		<div>
      <section class="share col-sm-6">
        <h4 class="section-title">Share Post</h4>
        <a class="btn btn-default btn-sm twitter" href="http://twitter.com/share?text=(SideTrack 1) File Polyglot"
           onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
          <i class="fa fa-twitter fa-lg"></i>
          Twitter
        </a>
        <a class="btn btn-default btn-sm facebook" href="https://www.facebook.com/sharer/sharer.php"
           onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
          <i class="fa fa-facebook fa-lg"></i>
          Facebook
        </a>
        <a class="btn btn-default btn-sm gplus"
           onclick="window.open('https://plus.google.com/share?url='+window.location.href, 'google-plus-share', 'width=490,height=530');return false;">
          <i class="fa fa-google-plus fa-lg"></i>
          Google+
        </a>
      </section>

      <section class="col-sm-6 author">
        <img src="//www.gravatar.com/avatar/e687cb78cf4a1242610b00314122ce64" class="img-rounded author-image" />
        <h4 class="section-title author-name">Ryan Jeon</h4>
        <p class="author-bio">I'm a software developer and a student. I am mainly interested in exploits and application development :)</p>
      </section>
    </div>

    <div class="clearfix"></div>

		<ul class="pager">
		  
		  <li class="previous"><a href="/general/demo/2019/06/04/hello-world.html" title="(SideTrack 0) Prologue">&larr; Previous</a></li>
		  
		  
		  <li class="next"><a href="/general/demo/2019/06/06/ssh-raspberrypi.html" title="SSH into RaspberryPi through GCP VM instance">Next &rarr;</a></li>
		  
		</ul>

		<hr>
	</div>
	
	<div class="col-sm-2 sidebar-2">
	
	</div>
</article>
<div class="clearfix"></div>





		<footer>
			<hr/>
			<p>
				&copy; 2020 Ryan Jeon
			</p>
		</footer>
	</div>

	<script type="text/javascript" src="/assets/resources/jquery/jquery.min.js"></script>
	<script type="text/javascript" src="/assets/resources/bootstrap/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="/assets/js/app.js"></script>
</body>
</html>



<!-- Asynchronous Google Analytics snippet -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-142682001-1', 'auto');
  ga('send', 'pageview');
</script>

